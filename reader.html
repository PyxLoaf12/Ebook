<!DOCTYPE html>
<html>
  <head>
    <title>eBook Reader</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <!-- üîñ Bookmark Controls -->
    <div id="bookmarks">
      <button onclick="saveBookmark()">üîñ Bookmark This Spot</button>
      <button onclick="goToBookmark()">üìç Go to Bookmark</button>
    </div>

    <h1>üìñ Now Reading</h1>

    <!-- üìë Chapter Dropdown -->
    <div id="chapterNav">
      <label for="chapterSelect">Jump to Chapter:</label>
      <select id="chapterSelect" onchange="goToChapter(this.value)">
        <option value="">-- Select --</option>
      </select>
    </div>

    <!-- üìñ Book Text Area -->
    <div id="bookText">Loading book...</div>

    <!-- üîß Controls -->
    <div id="controls">
      <button onclick="scrollToTop()">‚¨ÜÔ∏è Top</button>
      <button onclick="scrollToBottom()">‚¨áÔ∏è Bottom</button>
      <button onclick="increaseFont()">A+</button>
      <button onclick="decreaseFont()">A‚àí</button>
    </div>

    <!-- üîô Back to Library -->
    <button onclick="location.href='index.html'">‚¨Ö Back to Library</button>

    <!-- üß† JavaScript -->
    <script>
      const params = new URLSearchParams(window.location.search);
      const bookName = params.get("book");
      const fileName = `${bookName}.txt`;
      let chapterPositions = [];

      // ‚úÖ List of lyric-style books
      const lyricBooks = ["friendship", "mlp-song1", "elemental", "songdemo"];
      if (lyricBooks.includes(bookName)) {
        document.getElementById("bookText").classList.add("lyrics");
      }

      // ‚úÖ Load and parse book
      fetch(fileName)
        .then((response) => response.text())
        .then((text) => {
          const bookDiv = document.getElementById("bookText");
          const lines = text.split("\n");
          let contentHTML = "";
          chapterPositions = [];

          for (let i = 0; i < lines.length; i++) {
            const current = lines[i].trim();
            const next = lines[i + 1]?.trim() || "";

            if (/^\d+$/.test(current)) {
              const chapterId = `chapter-${chapterPositions.length}`;
              const chapterTitle = `${current}. ${next}`;
              chapterPositions.push({ id: chapterId, name: chapterTitle });

              contentHTML += `<h2 id="${chapterId}">${chapterTitle}</h2>\n`;
              i++;
            } else if (current !== "") {
              contentHTML += `<p>${current}</p>\n`;
            }
          }

          bookDiv.innerHTML = contentHTML;
          populateChapterDropdown();
        })
        .catch((error) => {
          document.getElementById("bookText").textContent =
            "‚ùå Could not load book.";
          console.error("Fetch error:", error);
        });

      function populateChapterDropdown() {
        const select = document.getElementById("chapterSelect");
        chapterPositions.forEach((chapter) => {
          const option = document.createElement("option");
          option.value = chapter.id;
          option.textContent = chapter.name;
          select.appendChild(option);
        });
      }

      function goToChapter(chapterId) {
        if (chapterId) {
          const target = document.getElementById(chapterId);
          if (target) {
            target.scrollIntoView({ behavior: "smooth" });
          }
        }
      }

      function scrollToTop() {
        document.getElementById("bookText").scrollTop = 0;
      }

      function scrollToBottom() {
        const book = document.getElementById("bookText");
        book.scrollTop = book.scrollHeight;
      }

      let currentFontSize = 20;

      function increaseFont() {
        currentFontSize += 2;
        document.getElementById("bookText").style.fontSize =
          currentFontSize + "px";
      }

      function decreaseFont() {
        currentFontSize = Math.max(12, currentFontSize - 2);
        document.getElementById("bookText").style.fontSize =
          currentFontSize + "px";
      }

      // üîñ Auto-save scroll position
      setInterval(() => {
        const scrollTop = document.getElementById("bookText").scrollTop;
        localStorage.setItem(`${bookName}-scroll`, scrollTop);
      }, 1000);

      // üîÑ Restore scroll position
      window.addEventListener("load", () => {
        const savedScroll = localStorage.getItem(`${bookName}-scroll`);
        if (savedScroll) {
          setTimeout(() => {
            document.getElementById("bookText").scrollTop =
              parseInt(savedScroll);
          }, 300);
        }
      });

      function saveBookmark() {
        const scrollTop = document.getElementById("bookText").scrollTop;
        localStorage.setItem(`${bookName}-bookmark`, scrollTop);
        alert("üìå Bookmark saved!");
      }

      function goToBookmark() {
        const saved = localStorage.getItem(`${bookName}-bookmark`);
        if (saved) {
          document.getElementById("bookText").scrollTop = parseInt(saved);
        } else {
          alert("‚ùå No bookmark saved yet.");
        }
      }
    </script>
  </body>
</html>
